---
import { useState } from "astro/jsx-runtime";
---

<section
    id="cart"
    class="fixed top-0 right-0 w-80 bg-white shadow-xl h-full hidden flex-col p-6 overflow-y-auto z-50"
>
    <h2 class="text-xl font-bold mb-4">ðŸ›’ Tu carrito</h2>
    <div id="cart-items" class="space-y-4"></div>
    <div class="mt-auto border-t pt-4">
        <p class="text-lg font-semibold">
            Total: <span id="cart-total">$0</span>
        </p>
        <button
            id="checkout-btn"
            class="px-4.5 font-medium h-9 text-xs bg-orange-500 text-white rounded-full flex
            items-center justify-center hover:bg-orange-600 duration-300 w-fit"
            >Finalizar compra</button
        >
    </div>
</section>

<script>
    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    const renderCart = () => {
        const container = document.querySelector("#cart-items");
        const totalEl = document.querySelector("#cart-total");

        if (!container) return;

        container.innerHTML = "";

        let total = 0;
        cart.forEach((item, index) => {
            total += item.price * item.quantity;
            container.innerHTML += `
        <div class="flex items-center justify-between border-b pb-2">
          <div>
            <p class="font-medium">${item.name}</p>
            <p class="text-sm text-gray-500">$${item.price} x ${item.quantity}</p>
          </div>
          <button class="text-red-500" onclick="removeFromCart(${index})">âœ•</button>
        </div>
      `;
        });

        totalEl.textContent = "$" + total.toFixed(2);
    };

    const removeFromCart = (index) => {
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
    };

    // Exponer para otros componentes
    window.addToCart = (product) => {
        const existing = cart.find((item) => item.id === product.id);
        if (existing) existing.quantity++;
        else cart.push({ ...product, quantity: 1 });
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
    };

    window.toggleCart = () => {
        document.querySelector("#cart").classList.toggle("hidden");
    };

    renderCart();

    window.addToCart = (product) => {
        const existing = cart.find((item) => item.id === product.id);
        if (existing) existing.quantity++;
        else cart.push({ ...product, quantity: 1 });
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();

        // PequeÃ±o feedback
        const btn = event.target;
        btn.textContent = "Agregado âœ…";
        setTimeout(() => (btn.textContent = "AÃ±adir al carrito"), 1000);
    };
</script>
